<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karaoke PSU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 100px; /* Space for fixed header */
        }
        .hover {
            cursor: pointer;
        }
        .highlighted {
            border: 2px solid #007bff;
        }
        .card-title {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            line-height: 1.2em; /* Adjust this line-height value as necessary */
            height: 3.6em; /* Should be line-height * 3 to ensure 3 lines are displayed */
            white-space: normal;
        }
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        .fixed-footer,
        .fixed-header {
            position: fixed;
            left: 0;
            width: 100%;
            background-color: #f8f9fa;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .fixed-header {
            top: 0;
        }
        .fixed-footer {
            bottom: 0;
        }
        .toggle-button {
            cursor: pointer;
        }
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        .dark-mode .fixed-header,
        .dark-mode .fixed-footer {
            background-color: #333333;
        }
        .dark-mode .card {
            background-color: #1f1f1f;
            color: #ffffff;
        }
        .dark-mode .list-group-item {
            background-color: #1f1f1f;
            color: #ffffff;
        }
        .dark-mode .form-control {
            background-color: #333333;
            color: #ffffff;
            border: 1px solid #555555;
        }
        .dark-mode .form-label {
            color: #ffffff;
        }
        /* Dark Mode Placeholder Text */
        .dark-mode input::placeholder {
            color: rgba(255, 255, 255, 0.7); /* Adjust opacity for visibility */
        }
        @media (max-width: 992px) {
            .playlist-item {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        /* Add this CSS */
.playlist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.playlist-item button {
    margin-left: 5px; /* Adjust margin as needed */
}

/* Optionally, you can adjust the button size */
.playlist-item button img {
    width: 16px;
    height: 16px;
}
/* Add this CSS */
/* Add this CSS */
.playlist-item {
    display: flex;
    align-items: center;
}

.playlist-title {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 10px; /* Adjust padding as needed */
}

.playlist-title:hover {
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
}


.delete-button-container {
    margin-left: 10px; /* Adjust margin as needed */
}


    </style>
</head>
<body>
<div class="fixed-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col">
                <button id="restartVideoButton" class="btn btn-info btn-sm">Restart</button>
                <button id="pauseButton" class="btn btn-info btn-sm">Pause</button>
                <label for="volumeSlider" class="form-label">Volume:</label>
                <input type="range" id="volumeSlider"  min="0" max="100" value="50">
            </div>
            <div class="col">
                <div id="playbackInfo"></div>
            </div>
            <div class="col">
                <button id="playNextVideoButton" class="btn btn-success btn-sm">Play Next Video</button>
            </div>
            <div class="col-auto">
                <button id="toggleButton" class="btn btn-lg toggle-button btn-danger">Auto Play</button>
                <button id="darkModeButton" class="btn btn-dark btn-sm">Dark Mode</button>
            </div>
        </div>
    </div>
</div>
<div class="container my-5">
    <h1 class="text-center">Karaoke PSU</h1>
    <div class="row">
        <div class="col-lg-8">
            <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search videos...">
            <div id="videoResults" class="row"></div>
        </div>
        <div class="col-lg-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Playlist</h3>
                <div>
                    <button id="refreshPlaylistButton" class="btn btn-info">Refresh Playlist</button>
                    <button id="clearPlaylistButton" class="btn btn-danger">Clear Playlist</button>
                </div>
            </div>
            <div class="input-group mb-3">
                <input type="text" id="urlInput" class="form-control" placeholder="Paste video URL here">
                <button id="addUrlButton" class="btn btn-primary">Add Video</button>
            </div>
            <ul id="playlist" class="list-group"></ul>
        </div>
    </div>
</div>
<div class="fixed-footer">
    <div class="container text-center">
        <button id="prevButton" class="btn btn-secondary">Previous</button>
        <button id="nextButton" class="btn btn-secondary">Next</button>
        <button id="addToPlaylistButton" class="btn btn-primary">Add to Playlist</button>
        <button id="addToBeginningButton" class="btn btn-primary">Add on top</button>
    </div>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script>
      const apiUrl = 'https://invidious.fdn.fr/api/v1';
      let playlist = JSON.parse(localStorage.getItem('playlist')) || [];
      let selectedVideos = [];
      let currentPage = 1;
      let searchQuery = '';
      let currentlyPlaying = null;
      let autoPlay = false;

      // Function to toggle dark mode
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  // Save the mode to localStorage
  if (document.body.classList.contains('dark-mode')) {
    localStorage.setItem('darkMode', 'enabled');
  } else {
    localStorage.setItem('darkMode', 'disabled');
  }
}

// Attach event listener to dark mode button
document.getElementById('darkModeButton').addEventListener('click', toggleDarkMode);

// Load the saved mode from localStorage
document.addEventListener('DOMContentLoaded', function() {
  const darkMode = localStorage.getItem('darkMode');
  if (darkMode === 'enabled') {
    document.body.classList.add('dark-mode');
  }
});
const invidiousApiUrl = 'https://invidious.fdn.fr/api/v1'; // Replace with your preferred Invidious instance if needed

// Function to fetch video details from Invidious API
async function fetchVideoDetails(videoId) {
  const response = await fetch(`${invidiousApiUrl}/videos/${videoId}`);
  if (response.ok) {
    const data = await response.json();
    return data;
  } else {
    return null;
  }
}

// Function to handle adding video by URL
async function addVideoByUrl() {
  const urlInput = document.getElementById('urlInput');
  const url = urlInput.value.trim();
  const videoId = extractVideoIdFromUrl(url);

  if (videoId) {
    const videoDetails = await fetchVideoDetails(videoId);
    if (videoDetails) {
      const video = {
        videoId: videoDetails.videoId,
        title: videoDetails.title,
        videoThumbnails: [{ url: videoDetails.videoThumbnails[0].url }]
      };
      if (!playlist.find(item => item.videoId === video.videoId)) {
        playlist.push(video);
        renderPlaylist();
        savePlaylist();
        urlInput.value = ''; // Clear the input field
      } else {
        alert('This video is already in the playlist.');
      }
    } else {
      alert('Video not found.');
    }
  } else {
    alert('Invalid URL.');
  }
}

// Function to extract video ID from YouTube/Invidious URL
function extractVideoIdFromUrl(url) {
  const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|invidio\.us\/watch\?v=)([a-zA-Z0-9_-]{11})/;
  const match = url.match(regex);
  return match ? match[1] : null;
}

// Attach event listener to the add URL button
document.getElementById('addUrlButton').addEventListener('click', addVideoByUrl);


      const toggleButton = document.getElementById('toggleButton');
      toggleButton.addEventListener('click', function() {
        // Toggle the boolean value
        autoPlay = !autoPlay;
        // Change button color based on the boolean value
        if (autoPlay) {
          toggleButton.classList.remove('btn-danger');
          toggleButton.classList.add('btn-success');
          toggleButton.textContent = "Auto Play";
        } else {
          toggleButton.classList.remove('btn-success');
          toggleButton.classList.add('btn-danger');
          toggleButton.textContent = "Auto Play";
        }
      });
      // Function to fetch videos from Invidious API
      async function searchVideos(query, page = 1) {
        const response = await fetch(`${apiUrl}/search?q=${query}&page=${page}`);
        const data = await response.json();
        return data;
      }
      // Function to render video thumbnails
function renderVideoThumbnails(videos) {
  const videoResults = document.getElementById('videoResults');
  videoResults.innerHTML = '';
  videos.forEach(video => {
    const thumbnailUrl = video.videoThumbnails[4]?.url;
    const title = video.title;
    const videoId = video.videoId;
    const thumbnail = document.createElement('div');
    thumbnail.classList.add('col-md-4', 'video-thumbnail');
    thumbnail.innerHTML = `
      <div class="card mb-3 hover">
        <img src="${thumbnailUrl}" class="card-img-top" alt="${title}">
        <div class="card-body">
          <h5 class="card-title" title="${title}">${title}</h5>
        </div>
      </div>
    `;
    const card = thumbnail.querySelector('.card.mb-3');
    card.addEventListener('click', () => selectVideo(thumbnail, video));
    videoResults.appendChild(thumbnail);
  });
}


// Function to handle video selection
function selectVideo(thumbnail, video) {
  const cardElement = thumbnail.querySelector('.card.mb-3');
  if (thumbnail.classList.contains('selected')) {
    thumbnail.classList.remove('selected');
    cardElement.classList.remove('highlighted'); // Remove highlighted class
    selectedVideos = selectedVideos.filter(v => v.videoId !== video.videoId);
  } else {
    thumbnail.classList.add('selected');
    cardElement.classList.add('highlighted'); // Add highlighted class
    selectedVideos.push(video);
  }
}
      // Function to add selected videos to playlist (end)
      function addToPlaylist() {
        selectedVideos.forEach(video => {
          if (!playlist.find(item => item.videoId === video.videoId)) {
            playlist.push(video);
          }
        });
        renderPlaylist();
        savePlaylist();
        clearSelection();
      }
      // Function to add selected videos to the beginning of the playlist
      function addToBeginning() {
        selectedVideos.forEach(video => {
          if (!playlist.find(item => item.videoId === video.videoId)) {
            playlist.unshift(video);
          }
        });
        renderPlaylist();
        savePlaylist();
        clearSelection();
      }
      // Function to render playlist
function renderPlaylist() {
    const playlistElement = document.getElementById('playlist');
    playlistElement.innerHTML = '';
    playlist.forEach((item, index) => {
        const listItem = document.createElement('li');
        listItem.classList.add('list-group-item', 'playlist-item');
        listItem.innerHTML = `
            <span class="playlist-title" title="${item.title}">${index + 1}. ${item.title}</span>
        `;
        playlistElement.appendChild(listItem);

        // Create container for delete button
        const buttonContainer = document.createElement('div');
        buttonContainer.classList.add('delete-button-container');

        // Create delete button
        const deleteButton = document.createElement('button');
        deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
        deleteButton.innerHTML = `
            <img src="trash-solid.svg" alt="Delete" width="16" height="16">
        `;
        deleteButton.addEventListener('click', () => removeFromPlaylist(index));

        // Append delete button to its container
        buttonContainer.appendChild(deleteButton);

        // Append delete button container to playlist item
        listItem.appendChild(buttonContainer);
    });
    // Initialize SortableJS for the playlist
    new Sortable(playlistElement, {
        animation: 150,
        onEnd: (event) => {
            const movedItem = playlist.splice(event.oldIndex, 1)[0];
            playlist.splice(event.newIndex, 0, movedItem);
            savePlaylist();
            renderPlaylist(); // Re-render to update the order
        }
    });
}



      // Function to clear selection
      function clearSelection() {
        selectedVideos = [];
        const thumbnails = document.querySelectorAll('.highlighted');
        thumbnails.forEach(thumbnail => thumbnail.classList.remove('highlighted'));
      }
      // Function to remove video from playlist
      function removeFromPlaylist(index) {
        playlist.splice(index, 1);
        savePlaylist();
        renderPlaylist();
      }

      function playNextVideo() {
        if (playlist.length > 0) {
          const nextVideo = playlist.shift();
          currentlyPlaying = nextVideo;
          savePlaylist();
          renderPlaylist();
          // Send the next video to MPV
          sendToMPV(nextVideo).then(response => {
            // Parse the MPV response
            const responseData = JSON.parse(response);
            // Check if the response includes "error": "success"
            if (responseData.error === "success") {
              // Set videoLoaded to true if the response is successful
              videoWaitingPlay = true;
            } else {
              // Handle error if the response is not successful
              console.error('Error playing next video:', responseData.error);
            }
          }).catch(error => {
            console.error('Error playing next video:', error);
            // Handle error if there is an issue with the request
          });
          console.log(nextVideo);
        } else {
          // No video in the playlist, handle accordingly
        }
      }
      // Function to restart the current video
      function restartVideo() {
        if (currentlyPlaying) {
          //document.getElementById('currentlyPlaying').textContent = `Now playing: ${currentlyPlaying.title}`;
          sendToMPV(currentlyPlaying);
        }
      }
      // Function to save playlist to localStorage
      function savePlaylist() {
        localStorage.setItem('playlist', JSON.stringify(playlist));
      }
      // Function to clear the playlist
      function clearPlaylist() {
        playlist = []; // Clear the playlist array
        savePlaylist(); // Save the empty playlist to localStorage
        renderPlaylist(); // Update the UI to reflect the changes
      }
      // Function to send video URL to MPV
      function sendToMPV(video) {
        const apiUrl = 'http://localhost:8080/post'; // Replace with your API URL
        console.log(video);
        // Define the POST request body containing the video URL
        const requestBody = JSON.stringify({
          command: ['loadfile', 'https://www.youtube.com/watch?v=' + video.videoId]
        });
        // Define POST request options
        const requestOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: requestBody
        };
        // Send POST request to the API
        fetch(apiUrl, requestOptions).then(response => {
          if (!response.ok) {
            throw new Error('Failed to send command to MPV');
          }
          console.log('Command sent successfully to MPV');
        }).catch(error => {
          console.error('Error:', error);
        });
      }

      function isMPVPidle() {
        const apiUrl = 'http://localhost:8080/post'; // Replace with your MPV API URL
        // Send request to MPV to get current pause state
        return sendRequest(apiUrl, {
          command: ['get_property', 'idle-active']
        }).then(response => {
          // Parse the MPV response
          const responseData = response['data'];
          // Extract the pause state from the response
          const isIdle = responseData;
          // Return true if MPV is playing, false otherwise
          return isIdle;
        }).catch(error => {
          console.error('Error checking if MPV is playing:', error);
          // Return false if there is an error
          return false;
        });
      }

      function isMPVPlaying() {
        const apiUrl = 'http://localhost:8080/post'; // Replace with your MPV API URL
        // Send request to MPV to get current pause state
        return sendRequest(apiUrl, {
          command: ['get_property', 'pause']
        }).then(response => {
          // Parse the MPV response
          const responseData = response['data'];
          // Extract the pause state from the response
          const isPaused = responseData;
          // Return true if MPV is playing, false otherwise
          return !isPaused; // Invert the pause state to determine if MPV is playing
        }).catch(error => {
          console.error('Error checking if MPV is playing:', error);
          // Return false if there is an error
          return false;
        });
      }
      // Function to update playback time and total duration
      function updatePlaybackInfo() {
        const apiUrl = 'http://localhost:8080/post'; // Replace with your API URL
        // Make separate POST requests to get playback time and total duration
        Promise.all([
          sendRequest(apiUrl, {
            command: ['get_property', 'time-pos']
          }),
          sendRequest(apiUrl, {
            command: ['get_property', 'duration']
          }),
          sendRequest(apiUrl, {
            command: ['get_property', 'media-title']
          }),
          sendRequest(apiUrl, {
            command: ['get_property', 'volume']
          })
        ]).then(responses => {
          const timePos = responses[0]['data'];
          const duration = responses[1]['data'];
          const title = responses[2]['data'];
          const volume = responses[3]['data'];
          // Convert playback time and duration from seconds to HH:MM:SS format
          const playbackTime = formatTime(timePos);
          const totalDuration = formatTime(duration);
          // Update HTML to display playback time, total duration, and video title
          document.getElementById('playbackInfo').innerHTML = `

									<strong>Playback:</strong> ${playbackTime} / ${totalDuration}
									<br>
										<strong>Title:</strong> ${title}
        `;
          const volumeSlider = document.getElementById('volumeSlider');
          volumeSlider.value = volume;
          if (typeof timePos === 'undefined' && typeof duration === 'undefined') {
            // Playback has ended
            isMPVPidle().then(isIdle => {
              if (isIdle) {
                if (playlist.length > 0 && autoPlay) {
                  // Play next video if playlist is not empty
                  playNextVideo();
                }
              }
            });
          } else {
            isMPVPlaying().then(isPlaying => {
              if (isPlaying) {
                document.getElementById('pauseButton').textContent = 'Pause';
                videoWaitingPlay = false;
              } else {
                document.getElementById('pauseButton').textContent = 'Resume';
              }
            });
          }
        }).catch(error => {
          console.error('Error:', error);
          // Display error message in console
        });
      }
      // Function to format time from seconds to HH:MM:SS format
      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      }
      // Function to make a POST request
      function sendRequest(url, requestBody) {
        // Define POST request options
        const requestOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        };
        // Send POST request and return response JSON
        return fetch(url, requestOptions).then(response => {
          if (!response.ok) {
            throw new Error('Failed to send request');
          }
          return response.json(); // Parse response JSON
        });
      }
      // Call updatePlaybackInfo function every 5 seconds
      setInterval(updatePlaybackInfo, 5000);
      // Function to send a pause or resume command to MPV
      function togglePause() {
        const apiUrl = 'http://localhost:8080/post'; // Replace with your API URL
        // Define current state of playback
        let pauseState = document.getElementById('pauseButton').textContent.trim().toLowerCase() === 'pause';
        // Define command based on current state
        const command = pauseState ? ['set_property', 'pause', true] : ['set_property', 'pause', false];
        // Send command to MPV
        sendRequest(apiUrl, {
          command: command
        }).then(() => {
          // Update button text based on new state
          document.getElementById('pauseButton').textContent = pauseState ? 'Resume' : 'Pause';
        }).catch(error => {
          console.error('Error:', error);
          // Display error message in console
        });
      }
      // Attach click event listener to the pause button
      document.getElementById('pauseButton').addEventListener('click', togglePause);
      // Function to set volume
      function setVolume() {
        const volume = document.getElementById('volumeSlider').value;
        const apiUrl = 'http://localhost:8080/post'; // Replace with your API URL
        // Send volume command to MPV
        sendRequest(apiUrl, {
          command: ['set_property', 'volume', volume]
        }).catch(error => {
          console.error('Error:', error);
          // Display error message in console
        });
      }
      // Attach click event listener to the pause button
      document.getElementById('pauseButton').addEventListener('click', togglePause);
      // Attach input event listener to the volume slider
      document.getElementById('volumeSlider').addEventListener('input', setVolume);
      document.addEventListener('DOMContentLoaded', function() {
        // Load playlist from localStorage
        playlist = JSON.parse(localStorage.getItem('playlist')) || [];
        // Render the playlist
        renderPlaylist();
      });
      // Function to refresh the playlist
      function refreshPlaylist() {
        playlist = JSON.parse(localStorage.getItem('playlist')) || []; // Reload playlist from localStorage
        renderPlaylist(); // Update the UI to reflect the changes
      }
      // Function to perform search
      async function performSearch() {
        const searchInput = document.getElementById('searchInput');
        searchQuery = searchInput.value.trim();
        if (searchQuery !== '') {
          currentPage = 1;
          const videos = await searchVideos(searchQuery, currentPage);
          renderVideoThumbnails(videos);
        }
      }
      // Event listener for input event on search input
      document.getElementById('searchInput').addEventListener('input', async (event) => {
        await performSearch();
      });
      // Event listener for keydown event on search input
      document.getElementById('searchInput').addEventListener('keydown', async (event) => {
        if (event.key === 'Enter') {
          await performSearch();
        }
      });
      // Event listener for "Add to Playlist" button
      document.getElementById('addToPlaylistButton').addEventListener('click', addToPlaylist);
      // Event listener for "Add to Beginning" button
      document.getElementById('addToBeginningButton').addEventListener('click', addToBeginning);
      // Event listener for "Previous" button
      document.getElementById('prevButton').addEventListener('click', async () => {
        if (currentPage > 1) {
          currentPage--;
          const videos = await searchVideos(searchQuery, currentPage);
          renderVideoThumbnails(videos);
        }
      });
      // Event listener for "Next" button
      document.getElementById('nextButton').addEventListener('click', async () => {
        currentPage++;
        const videos = await searchVideos(searchQuery, currentPage);
        renderVideoThumbnails(videos);
      });
      // Event listeners for the fixed header buttons
      document.getElementById('playNextVideoButton').addEventListener('click', playNextVideo);
      document.getElementById('restartVideoButton').addEventListener('click', restartVideo);
      // Event listener for "Clear Playlist" button
      document.getElementById('clearPlaylistButton').addEventListener('click', clearPlaylist);
      // Event listener for "Refresh Playlist" button
      document.getElementById('refreshPlaylistButton').addEventListener('click', refreshPlaylist);
    </script>

  </body>
</html>
